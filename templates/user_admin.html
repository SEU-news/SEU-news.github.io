<!-- templates/user_admin.html -->
<!DOCTYPE html>
<html>

<head>
    <title>User Admin</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
</head>

<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>用户管理</h2>
        <div>
            <strong>您好, 尊敬的管理员{{ session['username'] }}</strong>
            <a href="{{ url_for('admin') }}" class="btn btn-info">返回</a>
        </div>
    </div>
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Username</th>
                    <th>编辑权限</th>
                    <th>操作</th>
                    <th>管理员权限</th>
                    <th>操作</th>
                    <th>修改密码</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>
                        {% if user.has_editor_perm %}
                             <span class="badge permission-badge bg-success">有</span>
                        {% else %}
                            <span class="badge permission-badge bg-secondary">无</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.has_editor_perm %}
                           <form action="{{ url_for('role_edit', user_id=user.id, action='remove', permission='editor') }}" method="POST" style="display:inline-block;" onsubmit="return confirm('确定要移除编辑权限吗？');">
                               <button type="submit" class="btn btn-sm btn-warning">移除编辑权限</button>
                           </form>
                        {% else %}
                            <form action="{{ url_for('role_edit', user_id=user.id, action='grant', permission='editor') }}" method="POST" style="display:inline-block;" onsubmit="return confirm('确定要给予编辑权限吗？');">
                                <button type="submit" class="btn btn-sm btn-primary">升级为编辑</button>
                            </form>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.has_admin_perm %}
                            <span class="badge permission-badge bg-success">有</span>
                        {% else %}
                            <span class="badge permission-badge bg-secondary">无</span>
                        {% endif %}
                    </td>
                    <td>

                        {% if user.has_admin_perm %}
                            {% if user.username==session['username']%}
                                <button type="submit" class="btn btn-sm btn-secondary">不可移除自己的管理员权限</button>
                            {% else %}
                            <form action="{{ url_for('role_edit', user_id=user.id, action='remove', permission='admin') }}" method="POST" style="display:inline-block;" onsubmit="return confirm('确定要移除管理员权限吗？');">
                               <button type="submit" class="btn btn-sm btn-warning">移除管理员权限</button>
                            </form>
                            {% endif %}
                        {% else %}
                            <form action="{{ url_for('role_edit', user_id=user.id, action='grant', permission='admin') }}" method="POST" style="display:inline-block;" onsubmit="return confirm('确定要给予管理员权限吗？');">
                               <button type="submit" class="btn btn-sm btn-primary">升级为管理员</button>
                            </form>
                        {% endif %}
                    </td>
                    <td>
                        <!-- 修改密码按钮 -->
                        <button type="button" class="btn btn-sm btn-outline-info"
                                onclick="changePasswordModal('{{ user.id }}', '{{ user.username }}')">
                            修改密码
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
            <!-- 分页控件 -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">

                <!-- 上一页 -->
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link"
                           href="{{ url_for('user_admin', page=page-1, page_size=page_size, q=query) }}">上一页</a>
                    </li>
                {% endif %}

                <!-- 如果当前页 > 3，显示第一页和省略号 -->
                {% if page > 3 %}
                    <li class="page-item"><a class="page-link"
                                             href="{{ url_for('user_admin', page=1, page_size=page_size, q=query) }}">1</a></li>
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}

                <!-- 显示当前页附近页码 -->
                {% for p in range(nearby_start, nearby_end+1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('user_admin', page=p, page_size=page_size, q=query) }}">{{ p }}</a>
                    </li>
                {% endfor %}

                <!-- 如果当前页 < total_pages - 2，显示省略号和最后一页 -->
                {% if page < total_pages - 2 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    <li class="page-item"><a class="page-link"
                                             href="{{ url_for('user_admin', page=total_pages, page_size=page_size, q=query) }}">{{ total_pages }}</a>
                    </li>
                {% endif %}

                <!-- 下一页 -->
                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link"
                           href="{{ url_for('user_admin', page=page+1, page_size=page_size, q=query) }}">下一页</a>
                    </li>
                {% endif %}
            </ul>
         <!-- 页码跳转 -->
            <form class="d-flex justify-content-center mt-2" method="get" action="{{ url_for('user_admin') }}">
                <!-- 查询参数 -->
                <input type="hidden" name="page_size" value="{{ page_size }}">
                <input type="hidden" name="q" value="{{ query }}">
                <input type="number" class="form-control"
                       name="page" min="1" max="{{ total_pages }}"
                       placeholder="页码" style="width: 80px;">
                <button type="submit" class="btn btn-primary">Go</button>
            </form>
    </nav>

    <!-- 每页显示条数选择框 -->
    <form method="GET" class="mb-3" action="{{ url_for('user_admin') }}">
        <label for="page_size">每页显示：</label>
        <select name="page_size" id="page_size" onchange="this.form.submit()">
            <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
        </select>
        <input type="hidden" name="page" value="{{ page }}">
        <input type="hidden" name="q" value="{{ query }}">
    </form>

    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('change_password') }}" method="POST" id="passwordForm">
                    <div class="modal-header">
                        <h5 class="modal-title">修改密码 - <span id="modalUsername"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="user_id" id="targetUserId">
                        <div class="mb-3">
                            <p class="text-muted">正在为用户 <strong id="displayUsername" class="text-primary"></strong> 修改密码</p>
                            <label for="newPassword" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password"
                                   placeholder="请输入新密码" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">确认修改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script>
    function changePasswordModal(userId, username) {
        // 设置用户信息
        document.getElementById('targetUserId').value = userId;
        document.getElementById('modalUsername').textContent = username;
        document.getElementById('displayUsername').textContent = username;
        document.getElementById('newPassword').value = '';

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        modal.show();

        // 聚焦到输入框
        setTimeout(() => document.getElementById('newPassword').focus(), 500);
    }

    // 表单提交处理（如果需要二次确认）
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const password = document.getElementById('newPassword').value;
        const username = document.getElementById('displayUsername').textContent;

        if (confirm(`确定要为用户 ${username} 修改密码吗？`)) {
            this.submit();
        }
    });
    </script>
</body>

</html>